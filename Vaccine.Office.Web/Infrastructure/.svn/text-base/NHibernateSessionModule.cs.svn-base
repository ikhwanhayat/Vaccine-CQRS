using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using Autofac;
using NHibernate.Cfg;
using NHibernate.Dialect;
using NHibernate;
using NHibernate.Cfg.MappingSchema;
using NHibernate.Mapping.ByCode;
using System.Reflection;
using MediuCms.Core.Domain;
using MediuCms.Core.Domain.Model.Admission;
using NHibernate.Mapping.ByCode.Conformist;
using MediuCms.Core.Cqrs.Events;
using MediuCms.Core.Cqrs.Aggregate;
using MediuCms.Office.Web.Models.Reporting;

namespace MediuCms.Office.Web.Infrastructure
{
    public class NHibernateSessionModule : Autofac.Module
    {
        protected override void Load(ContainerBuilder builder)
        {
            var configuration = new Configuration();

            var map = GetMappings();

            configuration.DataBaseIntegration(c =>
            {
                c.Dialect<MsSql2008Dialect>();
                c.ConnectionString = @"Data Source=localhost\SQLEXPRESS;Initial Catalog=MediuCms;Integrated Security=True;Pooling=False";
                c.KeywordsAutoImport = Hbm2DDLKeyWords.AutoQuote;
                c.SchemaAction = SchemaAutoAction.Update;

            }).SetProperty("current_session_context_class", "web");

            configuration.AddDeserializedMapping(map, "NHSchemaTest");

            var sessionFactory = configuration.BuildSessionFactory();

            builder.RegisterInstance(sessionFactory).As<ISessionFactory>().SingleInstance();
        }

        private HbmMapping GetMappings()
        {
            var mapper = new ConventionModelMapper();

            //var baseEntityType = typeof(Entity);
            //mapper.IsEntity((t, declared) => baseEntityType.IsAssignableFrom(t) && baseEntityType != t && !t.IsInterface);
            //mapper.IsRootEntity((t, declared) => baseEntityType.Equals(t.BaseType));
 
            
            mapper.BeforeMapClass += (mi, type, map) =>
            {
                map.Id(g => g.Generator(Generators.GuidComb));
            };

            mapper.Class<StoredEvent>(m => m.Property("PayLoad", c => c.Type<NHibernate.Type.BinaryBlobType>()));

            

            //mapper.BeforeMapBag += (mi, type, map) =>
            //{
            //    map.Inverse(true);
            //    map.Lazy(CollectionLazy.Lazy);
            //};

            //AcademicApplication
            //mapper.Class<AcademicApplication>(m =>
            //    {
            //        m.Bag(x => x.AdmissionStatuses, cm =>
            //        {
            //            cm.Table("AdmissionStatus");
            //            cm.Cascade(Cascade.All);
            //            cm.Key(k => k.Column("AcademicApplication"));
            //        });
            //    }
            //);

            //mapper.Class<AdmissionWorkFlow>(m =>
            //    {
            //        m.Bag(x => x.AdmissionWorkFlows, cm =>
            //        {

            //            cm.Table("AdmissionWorkFlow");
            //            cm.Cascade(Cascade.All);
            //            cm.Key(k => k.Column("ParentAdmissionWorkFlow"));
            //            cm.Inverse(true);
            //        });
                    
            //    }
            //);


            var entities = new List<Type> { typeof(AggregateVersion), typeof(StoredEvent), typeof(BankAccountReport) };// Assembly.Load("MediuCms.Core.Cqrs").GetTypes();

            HbmMapping domainMapping = mapper.CompileMappingFor(entities);

            return domainMapping;
        }

    }

    
}